(function($){var reset_data_dialog=$("#reset-data-dialog");reset_data_dialog.dialog({dialogClass:'wp-dialog',modal:!0,autoOpen:!1,closeOnEscape:!0,draggable:!1,width:500,buttons:[{text:"Yes, delete it permanently",class:"button-primary reset-data-button",click:function(){$('.reset-data-button').prop('disabled',!0);$('.reset-data-button').parent().parent().prepend('<span id="reset-data-response"><span class="spinner is-active" style="float: none;"></span></span>');var items=[];$('.cmb2-id-data-to-reset input:checked').each(function(){items.push($(this).val())});$.post(ajaxurl,{action:'gamipress_reset_data_tool',items:items},function(response){if(response.success===!1){$('#reset-data-response').css({color:'#a00'})}
$('#reset-data-response').html(response.data);if(response.success===!0){setTimeout(function(){$('.cmb2-id-data-to-reset input:checked').each(function(){$(this).prop('checked',!1)});$('#reset-data-response').remove();reset_data_dialog.dialog("close")},2000)}
$('.reset-data-button').prop('disabled',!1)})}},{text:"Cancel",class:"cancel-reset-data-button",click:function(){$(this).dialog("close")}}]});$("#reset_data").click(function(e){e.preventDefault();$('#reset-data-warning').remove();var checked_options=$('.cmb2-id-data-to-reset input:checked');if(checked_options.length){var reminder_html='';checked_options.each(function(){reminder_html+='<li>'+$(this).next().text()+'</li>'});$('#reset-data-reminder').html('<ul>'+reminder_html+'</ul>');reset_data_dialog.dialog('open');$('.ui-dialog :button').blur()}else{$(this).parent().prepend('<p id="reset-data-warning" class="cmb2-metabox-description" style="color: #a00;">You need to choose at least one option.</p>')}});$('.cmb2-id-data-to-reset').on('change','input',function(){$('#reset-data-warning').remove();var checked_option=$(this).val();if(checked_option==='achievement_types'){$('.cmb2-id-data-to-reset input[value="achievements"], .cmb2-id-data-to-reset input[value="steps"]').prop('checked',$(this).prop('checked'))}else if(checked_option==='achievements'){$('.cmb2-id-data-to-reset input[value="steps"]').prop('checked',$(this).prop('checked'))}else if(checked_option==='points_types'){$('.cmb2-id-data-to-reset input[value="points_awards"]').prop('checked',$(this).prop('checked'));$('.cmb2-id-data-to-reset input[value="points_deducts"]').prop('checked',$(this).prop('checked'))}else if(checked_option==='rank_types'){$('.cmb2-id-data-to-reset input[value="ranks"], .cmb2-id-data-to-reset input[value="rank_requirements"]').prop('checked',$(this).prop('checked'))}else if(checked_option==='ranks'){$('.cmb2-id-data-to-reset input[value="rank_requirements"]').prop('checked',$(this).prop('checked'))}else if(checked_option==='earnings'){$('.cmb2-id-data-to-reset input[value="earned_points"], .cmb2-id-data-to-reset input[value="earned_achievements"], .cmb2-id-data-to-reset input[value="earned_ranks"]').prop('checked',$(this).prop('checked'))}});var to_export=[];function gamipress_run_export_tool(type,loop){var button_element=$('#export_'+type);var response_element=$('#export-'+type+'-response');var data;if(loop===undefined){loop=0}
button_element.prop('disabled',!0);if(!response_element.length){button_element.parent().append('<span id="export-'+type+'-response" style="display: inline-block; padding: 5px 0 0 8px;"></span>');response_element=$('#export-'+type+'-response')}
if(!response_element.find('.spinner').length){response_element.html('<span class="spinner is-active" style="float: none; margin: 0;"></span>')}
switch(type){case 'achievements':var achievement_types=[];$('input[name="export_achievements_achievement_types[]"]:checked').each(function(){achievement_types.push($(this).val())});data={action:'gamipress_import_export_achievements_tool_export',achievement_types:achievement_types,user_field:$('#export_achievements_user_field').val(),achievement_field:$('#export_achievements_achievement_field').val(),loop:loop};break;case 'points':var points_types=[];$('input[name="export_points_points_types[]"]:checked').each(function(){points_types.push($(this).val())});data={action:'gamipress_import_export_points_tool_export',points_types:points_types,user_field:$('#export_points_user_field').val(),loop:loop};break;case 'ranks':var rank_types=[];$('input[name="export_ranks_rank_types[]"]:checked').each(function(){rank_types.push($(this).val())});data={action:'gamipress_import_export_ranks_tool_export',rank_types:rank_types,user_field:$('#export_ranks_user_field').val(),rank_field:$('#export_ranks_rank_field').val(),loop:loop};break}
$.post(ajaxurl,data,function(response){if(response.data.items!==undefined){to_export=to_export.concat(response.data.items)}
if(response.data.run_again!==undefined&&response.data.run_again&&response.success===!0){if(!response_element.find('#export-'+type+'-response-message').length){response_element.append('<span id="export-'+type+'-response-message" style="padding-left: 5px;"></span>')}
response_element.find('#export-'+type+'-response-message').html(response.data.message);loop++;gamipress_run_export_tool(type,loop);return}
if(response.success===!1){response_element.css({color:'#a00'})}
response_element.html((response.data.message!==undefined?response.data.message:response.data));button_element.prop('disabled',!1);if(to_export.length){gamipress_download_csv(to_export,'gamipress-user-'+type+'-export')}}).fail(function(){response_element.html('The server has returned an internal error.');button_element.prop('disabled',!1)})}
$('#export_achievements, #export_points, #export_ranks').click(function(e){e.preventDefault();var $this=$(this);var type;var error='';switch($this.attr('id')){case 'export_achievements':type='achievements';if(!$('input[name="export_achievements_achievement_types[]"]:checked').length){error='You need to choose at least 1 achievement type to export.'}
break;case 'export_points':type='points';if(!$('input[name="export_points_points_types[]"]:checked').length){error='You need to choose at least 1 points type to export.'}
break;case 'export_ranks':type='ranks';if(!$('input[name="export_ranks_rank_types[]"]:checked').length){error='You need to choose at least 1 rank type to export.'}
break}
$('#export-'+type+'-warning').remove();if(error!==''){$this.parent().prepend('<p id="export-'+type+'-warning" class="cmb2-metabox-description" style="color: #a00;">'+error+'</p>');return!1}
to_export=[];gamipress_run_export_tool(type)});$('#import_achievements, #import_points, #import_ranks').click(function(e){e.preventDefault();var $this=$(this);var type;switch($this.attr('id')){case 'import_achievements':type='achievements';break;case 'import_points':type='points';break;case 'import_ranks':type='ranks';break}
$('#import-'+type+'-warning').remove();if($('#import_'+type+'_file')[0].files[0]===undefined){$this.parent().prepend('<p id="import-'+type+'-warning" class="cmb2-metabox-description" style="color: #a00;">You need to choose a CSV file to import.</p>');return!1}
var form_data=new FormData();form_data.append('action','gamipress_import_export_'+type+'_tool_import');form_data.append('file',$('#import_'+type+'_file')[0].files[0]);$this.prop('disabled',!0);$this.parent().prepend('<p id="import-'+type+'-response" class="cmb2-metabox-description"><span class="spinner is-active" style="float: none;"></span></p>');$.ajax({url:ajaxurl,method:'post',cache:!1,contentType:!1,processData:!1,data:form_data,success:function(response){if(response.success===!1){$('#import-'+type+'-response').css({color:'#a00'})}
$('#import-'+type+'-response').html(response.data);$this.prop('disabled',!1)}})});$('#download_achievements_csv_template, #download_points_csv_template, #download_ranks_csv_template').click(function(e){e.preventDefault();var type,sample_data;switch($(this).attr('id')){case 'download_achievements_csv_template':type='achievements';sample_data=[{user:'User (ID, username or email)',achievements:'Achievements (Comma-separated list of IDs, titles and/or slugs)',},{user:gamipress_admin_tools.user_id,achievements:'1,2,3',},{user:gamipress_admin_tools.user_name,achievements:'Test Badge,Custom Quest,Super Achievement',},{user:gamipress_admin_tools.user_email,achievements:'test-badge,custom-quest,super-achievement',},{user:gamipress_admin_tools.user_id,achievements:'1,Test Badge,test-badge',},];break;case 'download_points_csv_template':type='points';sample_data=[{user:'User (ID, username or email)',points:'Points',points_type:'Points Type (slug)',log:'Log Description (Optional)'},{user:gamipress_admin_tools.user_id,points:'100',points_type:'credits',log:'100 credits awarded through the user\'s ID'},{user:gamipress_admin_tools.user_name,points:'1000',points_type:'coins',log:'1,000 coins awarded through the user\'s username'},{user:gamipress_admin_tools.user_email,points:'50',points_type:'gems',log:'50 gems awarded through the user\'s email'},];break;case 'download_ranks_csv_template':type='ranks';sample_data=[{user:'User (ID, username or email)',rank:'Rank (ID, title or slug of rank to assign to the user)',},{user:gamipress_admin_tools.user_id,rank:'1',},{user:gamipress_admin_tools.user_name,rank:'Test Rank',},{user:gamipress_admin_tools.user_email,rank:'test-rank',},];break}
if(Array.isArray(sample_data)){gamipress_download_csv(sample_data,'gamipress-'+type+'-csv-template')}});$('#import_settings').click(function(e){e.preventDefault();$('#import-settings-warning').remove();if($('#import_settings_file')[0].files[0]===undefined){$(this).parent().prepend('<p id="import-settings-warning" class="cmb2-metabox-description" style="color: #a00;">You need to choose a configuration file to import.</p>');return!1}
var $this=$(this);var form_data=new FormData();form_data.append('action','gamipress_import_settings_tool');form_data.append('file',$('#import_settings_file')[0].files[0]);$this.prop('disabled',!0);$this.parent().append('<span id="import-settings-response"><span class="spinner is-active" style="float: none;"></span></span>');$.ajax({url:ajaxurl,method:'post',cache:!1,contentType:!1,processData:!1,data:form_data,success:function(response){if(response.success===!1){$('#import-settings-response').css({color:'#a00'})}
$('#import-settings-response').html(response.data);if(response.success===!0){setTimeout(function(){$('#import-settings-response').remove()},2000)}
$this.prop('disabled',!1)}})});function gamipress_run_recount_activity_tool(loop){if(loop===undefined){loop=0}
var button=$("#recount_activity");var activity=$('#activity_to_recount').val();$.post(ajaxurl,{action:'gamipress_recount_activity_tool',activity:activity,loop:loop},function(response){if(response.data.run_again!==undefined&&response.data.run_again&&response.success===!0){var running_selector='#recount-activity-response #running-'+activity;if(!$(running_selector).length){$('#recount-activity-response').append('<span id="running-'+activity+'"></span>')}
$(running_selector).html(response.data.message);loop++;gamipress_run_recount_activity_tool(loop);return}
$('#recount-activity-notice').remove();if(response.success===!1){$('#recount-activity-response').css({color:'#a00'})}
$('#recount-activity-response').html(response.data);if(response.success===!0){setTimeout(function(){$('#recount-activity-response').remove()},2000)}
button.prop('disabled',!1);$('#activity_to_recount').prop('disabled',!1)}).fail(function(){$('#recount-activity-response').html('The server has returned an internal error.');setTimeout(function(){$('#recount-activity-notice').remove();$('#recount-activity-response').remove()},5000);button.prop('disabled',!1);$('#activity_to_recount').prop('disabled',!1)})}
$("#recount_activity").click(function(e){e.preventDefault();$('#recount-activity-warning').remove();if($('#activity_to_recount').val()===''){$(this).parent().prepend('<p id="recount-activity-warning" class="cmb2-metabox-description" style="color: #a00;">You need to choose an activity to recount.</p>');return!1}
var $this=$(this);$this.prop('disabled',!0);$('#activity_to_recount').prop('disabled',!0);$this.parent().prepend('<p id="recount-activity-notice" class="cmb2-metabox-description">'+gamipress_admin_tools.recount_activity_notice+'</p>');if(!$('#recount-activity-response').length){$this.parent().append('<span id="recount-activity-response"></span>')}
$('#recount-activity-response').html('<span class="spinner is-active" style="float: none;"></span>');gamipress_run_recount_activity_tool()});$('#bulk-awards, #bulk-revokes').on('change','#bulk_award_points_all_users, #bulk_award_achievements_all_users, #bulk_award_rank_all_users, '+'#bulk_revoke_points_all_users, #bulk_revoke_achievements_all_users, #bulk_revoke_rank_all_users',function(){var target=$('#'+$(this).attr('id').replace('_all','')).closest('.cmb-row');if($(this).prop('checked')){target.slideUp(250).addClass('cmb2-tab-ignore')}else{target.slideDown(250).removeClass('cmb2-tab-ignore')}});$('#bulk_award_achievements, #bulk_revoke_achievements').select2({ajax:{url:ajaxurl,dataType:'json',delay:250,type:'POST',cache:!0,data:function(params){return{q:params.term,action:'gamipress_get_achievements_options'}},processResults:gamipress_select2_posts_process_results},escapeMarkup:function(markup){return markup},templateResult:gamipress_select2_posts_template_result,theme:'default gamipress-select2',placeholder:gamipress_admin_tools.achievements_placeholder,allowClear:!0,closeOnSelect:!1,multiple:!0});$('#bulk_award_rank, #bulk_revoke_rank').select2({ajax:{url:ajaxurl,dataType:'json',delay:250,type:'POST',cache:!0,data:function(params){return{q:params.term,action:'gamipress_get_ranks_options'}},processResults:gamipress_select2_posts_process_results},escapeMarkup:function(markup){return markup},templateResult:gamipress_select2_posts_template_result,theme:'default gamipress-select2',placeholder:gamipress_admin_tools.rank_placeholder,allowClear:!0,multiple:!1});$('#bulk_award_points_users, #bulk_award_achievements_users, #bulk_award_rank_users, '+'#bulk_revoke_points_users, #bulk_revoke_achievements_users, #bulk_revoke_rank_users').select2({ajax:{url:ajaxurl,dataType:'json',delay:250,type:'POST',cache:!0,data:function(params){return{q:params.term,page:params.page||1,action:'gamipress_get_users'}},processResults:gamipress_select2_users_process_results},escapeMarkup:function(markup){return markup},templateResult:gamipress_select2_users_template_result,theme:'default gamipress-select2',placeholder:gamipress_admin_tools.users_placeholder,allowClear:!0,closeOnSelect:!1,multiple:!0});function gamipress_run_bulk_tool(button,loop){if(loop===undefined){loop=0}
var response_id=button.attr('id').replace('_button','_response');var active_tab=button.closest('.cmb-tabs-wrap').find('.cmb-tab.active');var action=(button.attr('id').indexOf('bulk_award_')!==-1?'bulk_award':'bulk_revoke');var data;if(action==='bulk_award'){data={action:'gamipress_bulk_awards_tool',bulk_award:button.attr('id').replace('bulk_award_','').replace('_button',''),loop:loop}}else if(action==='bulk_revoke'){data={action:'gamipress_bulk_revokes_tool',bulk_revoke:button.attr('id').replace('bulk_revoke_','').replace('_button',''),loop:loop}}
$(active_tab.data('fields')).find('input, select, textarea').each(function(){if($(this).attr('type')==='checkbox'){if($(this).prop('checked')){data[$(this).attr('name')]=$(this).val()}}else{data[$(this).attr('name')]=$(this).val()}});button.prop('disabled',!0);if(!$('#'+response_id).length){button.parent().append('<span id="'+response_id+'" style="display: inline-block; padding: 5px 0 0 8px;"></span>')}
if(!$('#'+response_id).find('.spinner').length){$('#'+response_id).html('<span class="spinner is-active" style="float: none; margin: 0;"></span>')}
$.post(ajaxurl,data,function(response){if(response.data.run_again!==undefined&&response.data.run_again&&response.success===!0){if(!$('#'+response_id).find('#'+response_id+'-message').length){$('#'+response_id).append('<span id="'+response_id+'-message" style="padding-left: 5px;"></span>')}
$('#'+response_id).find('#'+response_id+'-message').html(response.data.message);loop++;gamipress_run_bulk_tool(button,loop);return}
if(response.success===!1){$('#'+response_id).css({color:'#a00'})}
$('#'+response_id).html(response.data);if(response.success!==!1){loop++}
button.prop('disabled',!1)}).fail(function(){$('#'+response_id).html('The server has returned an internal error.');button.prop('disabled',!1)})}
$('#bulk_award_points_button, #bulk_award_achievements_button, #bulk_award_rank_button, '+'#bulk_revoke_points_button, #bulk_revoke_achievements_button, #bulk_revoke_rank_button').click(function(e){e.preventDefault();gamipress_run_bulk_tool($(this))});if(gamipress_is_select2_updated()){var field_row=$('.cmb-type-display.cmb2-id-gamipress-select2');var field=field_row.find('.cmb-td span');field_row.addClass('gamipress-label-success').removeClass('gamipress-label-danger');field.addClass('gamipress-label-success').removeClass('gamipress-label-danger');field.text('Updated')}})(jQuery)